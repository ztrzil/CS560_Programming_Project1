
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>http_server &#8212; Programming_Assignment_1_CS560 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for http_server</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">const</span>
<span class="kn">import</span> <span class="nn">uuid</span> <span class="c1"># create random file name</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="c1"># sanitize upload file names</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="k">import</span> <span class="n">secure_filename</span>


<div class="viewcode-block" id="check_args"><a class="viewcode-back" href="../http_server.html#http_server.check_args">[docs]</a><span class="k">def</span> <span class="nf">check_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Check for and parse the command line arguments given to the program.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    args : list of str</span>
<span class="sd">        The command line arguments, if any, passed to the program as a list.</span>

<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    argparse.Namespace object</span>
<span class="sd">        This class has all of the argument values (including defaults) in it.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;HTTP Server that uses sockets </span><span class="se">\</span>
<span class="s1">      to receive and respond to requests. Serves content with proper headers, </span><span class="se">\</span>
<span class="s1">      responds to requests for web pages, allows for user file uploads, and </span><span class="se">\</span>
<span class="s1">      supports directory listing for the upload directory.&#39;</span><span class="p">)</span>
  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--ip_addr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify </span><span class="se">\</span>
<span class="s2">      the IP address to bind the server to. Default is 0.0.0.0&quot;</span><span class="p">)</span>
  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify the </span><span class="se">\</span>
<span class="s2">      port to bind the server to. Default is random avaialble port.&quot;</span><span class="p">)</span>
  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;More verbose printing&quot;</span><span class="p">)</span>
  <span class="n">results</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="HttpServer"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer">[docs]</a><span class="k">class</span> <span class="nc">HttpServer</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot; Our HTTP Sever class. The class has all the required functionality for</span>
<span class="sd">  starting the server, binding it to an address and port, monitoring for</span>
<span class="sd">  connections, responding to requests, and serving content. It&#39;s design</span>
<span class="sd">  includes the three required features in the project write-up: </span>
<span class="sd">    1. Respond to HTTP requests with query and header parsing</span>
<span class="sd">    2. HTML page navigation </span>
<span class="sd">    3. Static file transport allowing users to submit a file to the server side</span>

<span class="sd">  Directory listing is available for only the upload directory and subfolders</span>
<span class="sd">  of the upload directory. This is a security measure to prevent arbitrary path</span>
<span class="sd">  traversal.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    www_dir : str</span>
<span class="sd">        The directory, relative to the base directory where the HTML files are</span>
<span class="sd">        stored.</span>
<span class="sd">    upload_dir : str</span>
<span class="sd">        The directory, relative to the base directory where the files uploaded</span>
<span class="sd">        by the user are stored.</span>
<span class="sd">  &quot;&quot;&quot;</span>


  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addr</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Constructor</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ip_addr : str, optional</span>
<span class="sd">        Ip address to bind the socket to. Default is empty str which binds to</span>
<span class="sd">        0.0.0.0</span>
<span class="sd">    port : int, optional</span>
<span class="sd">        Port that the socket binds to. Default is a random, available port</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        The server prints some info to the command line. Should this printing</span>
<span class="sd">        be verbose.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip_addr</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">=</span> <span class="s1">&#39;www&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span> <span class="o">=</span> <span class="s1">&#39;www/upload&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>


<div class="viewcode-block" id="HttpServer.start_server"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer.start_server">[docs]</a>  <span class="k">def</span> <span class="nf">start_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Open the socket, and bind it to the address and port set in the</span>
<span class="sd">    constructor. If unable to connect on the specified port because address is</span>
<span class="sd">    already in use, try again. This is useful for testing or immediate restart.</span>
<span class="sd">    Once we bind the socket, call the loop that waits for connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
      <span class="k">if</span> <span class="n">ip</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting HTTP server at </span><span class="si">{}</span><span class="s1"> on port </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Failed to start HTTP server.&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">if</span> <span class="s1">&#39;Address already in use&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Trying to start HTTP server on a free port. . .&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_server</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_connections</span><span class="p">()</span></div>


<div class="viewcode-block" id="HttpServer._generate_headers"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._generate_headers">[docs]</a>  <span class="k">def</span> <span class="nf">_generate_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate appropriate header based on status code. Return the header</span>
<span class="sd">    encoded as a bytes object so that it can be sent to the browser. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    status_code : int</span>
<span class="sd">        The status code that will be set in the header</span>

<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    bytes object</span>
<span class="sd">        The header with the necessary fields set appropriately and encoded to</span>
<span class="sd">        be sent over the socket. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_OK</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> OK</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_OK</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_BAD_REQ</span><span class="p">:</span>
      <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FILE_NOT_FOUND</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> OK</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FILE_NOT_FOUND</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FORBIDDEN</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> Forbidden</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FORBIDDEN</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_INTERNAL_ERROR</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> Internal Error</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_INTERNAL_ERROR</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_UNSUPPORTED_MEDIA_TYPE</span><span class="p">:</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> Unsupported Media Type</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_UNSUPPORTED_MEDIA_TYPE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#unrecognized status</span>
      <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.1 </span><span class="si">{}</span><span class="s1"> Bad Request</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_BAD_REQ</span><span class="p">)</span>

    <span class="c1"># add more fields to the header, regardless of status code</span>
    <span class="n">cur_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1"> </span><span class="si">%d</span><span class="s1"> %b %Y %H %M %S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;Date: &#39;</span> <span class="o">+</span> <span class="n">cur_date</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;Server: &#39;</span> <span class="o">+</span> <span class="n">const</span><span class="o">.</span><span class="n">SERVER_SIGNATURE</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;Connection: close</span><span class="se">\r\n</span><span class="s1">&#39;</span>
    <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;Content-Type: text/html</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span>

    <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>


<div class="viewcode-block" id="HttpServer._get_content"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._get_content">[docs]</a>  <span class="k">def</span> <span class="nf">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Open up the webpage and return it. Note: opening file in binary mode,</span>
<span class="sd">    so the content does not need to be encoded like the header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path of the file that the user is requesting. </span>

<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    bytes object</span>
<span class="sd">        The contents of the file (should be HTML) to be sent to the socket</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
      <span class="n">content</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">content</span></div>


<div class="viewcode-block" id="HttpServer._traverse_uploads"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._traverse_uploads">[docs]</a>  <span class="k">def</span> <span class="nf">_traverse_uploads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Traverses the directory and lists the files contained therein.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Path of directory being requested by user that has files to list</span>

<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    bytes object</span>
<span class="sd">    #with open(self.upload_dir + &#39;/&#39; + file_name, &#39;wb&#39;) as fp:</span>
<span class="sd">    #with open(self.www_dir + &#39;/&#39; + self.upload_dir + &#39;/&#39; + file_name, &#39;wb&#39;) as fp:</span>
<span class="sd">        The HTML displaying the files in the directory encoded to be sent via</span>
<span class="sd">        the socket</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span> 
      <span class="n">path</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
      <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="n">f</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">link</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">f</span>
      <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&lt;a href=&#39;</span> <span class="o">+</span> <span class="n">link</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="s1">&#39;&lt;/a&gt;&lt;br&gt;&#39;</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span></div>



<div class="viewcode-block" id="HttpServer._serve_content"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._serve_content">[docs]</a>  <span class="k">def</span> <span class="nf">_serve_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_file</span><span class="p">,</span> <span class="n">req_method</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_OK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fetch the header, open the necessary file, and return the headers and</span>
<span class="sd">    file to the socket.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    req_file : str</span>
<span class="sd">        The name of the file that is being requested</span>
<span class="sd">    req_method : str</span>
<span class="sd">        The request method, should be GET or POST</span>
<span class="sd">    conn : socket.socket object</span>
<span class="sd">        The handle to the socket over which the content will be served</span>
<span class="sd">    status : int</span>
<span class="sd">        The status code that will be put in the header. This may be changed in</span>
<span class="sd">        this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_BAD_REQ</span><span class="p">:</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_BAD_REQ</span><span class="p">)</span>
      <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;error_400.html&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FORBIDDEN</span><span class="p">:</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
      <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;error_403.html&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_UNSUPPORTED_MEDIA_TYPE</span><span class="p">:</span>
      <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
      <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;error_415.html&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span> 
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span><span class="p">)</span> <span class="ow">in</span> <span class="n">req_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">req_file</span><span class="p">):</span>
          <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_traverse_uploads</span><span class="p">(</span><span class="n">req_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="n">req_file</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="c1">#      except FileNotFoundError as e:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FILE_NOT_FOUND</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;error_404.html&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_headers</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_INTERNAL_ERROR</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;error_500.html&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">headers</span> <span class="o">+</span> <span class="n">content</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Terminating connection with client&#39;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="HttpServer._upload_file"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._upload_file">[docs]</a>  <span class="k">def</span> <span class="nf">_upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handle file uploads by a user via HTML form. This function will save</span>
<span class="sd">    the file uploaded by the user to the upload directory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fields : list of lists of str</span>
<span class="sd">        The lists in fields are the different HTML headers. Each str element in</span>
<span class="sd">        each list is a space delimited value of that header.            </span>
<span class="sd">    data : bytes object</span>
<span class="sd">        The initial data received from the socket. Contains HTML headers</span>
<span class="sd">    conn : socket.socket object</span>
<span class="sd">        The handle to the socket that we&#39;re listening on. Will be used to</span>
<span class="sd">        receive the rest of the data from the client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
      <span class="n">chunk</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
      <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
      <span class="n">parts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># error</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serve_content</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_INTERNAL_ERROR</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;filename=</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="c1"># sanitize filename</span>
    <span class="k">if</span> <span class="n">file_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># handle if sanitize returns empty filename or file exists</span>
      <span class="n">file_name</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="n">exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
      <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
      <span class="n">file_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File to upload: &#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span> 
    <span class="c1"># In listening for the form data (filename, etc. we may have already</span>
    <span class="c1"># received some of the file data</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
      <span class="n">content</span> <span class="o">+=</span> <span class="n">part</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">chunk</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span> <span class="k">break</span>
      <span class="n">content</span> <span class="o">+=</span> <span class="n">chunk</span>
    <span class="c1"># Don&#39;t write what is after the boundary as it is not part of the file</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">------&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
      <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_serve_content</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/upload_success.html&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span></div>


  <span class="k">def</span> <span class="nf">__is_safe_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check for an attempt at path traversal.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path being requested by the client that needs to be validated.</span>
<span class="sd">    </span>
<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Boolean of the check if the user is requesting file at the proper path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="n">basedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="n">basedir</span><span class="p">])</span> <span class="o">==</span> <span class="n">basedir</span><span class="p">)</span> <span class="ow">or</span>
      <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">upload_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>


<div class="viewcode-block" id="HttpServer._handle_request"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._handle_request">[docs]</a>  <span class="k">def</span> <span class="nf">_handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Called each time a request is received on the socket. This function</span>
<span class="sd">    checks the type of request -- GET or POST -- and does some some safety</span>
<span class="sd">    checking for path traversal before handing the request and data off to</span>
<span class="sd">    the function that will serve it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : bytes object</span>
<span class="sd">        The initial data received from the socket. Contains HTML headers</span>
<span class="sd">    conn : socket.socket object</span>
<span class="sd">        The handle to the socket that we&#39;re listening on. Will be used to</span>
<span class="sd">        receive the rest of the data from the client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span> 
    <span class="n">request_method</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Request method: &#39;</span><span class="p">,</span> <span class="n">request_method</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Header fields:&#39;</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request_method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="ow">or</span> <span class="n">request_method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">:</span>
      <span class="n">req_file</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">req_file</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="n">req_file</span> <span class="o">+=</span> <span class="s1">&#39;index.html&#39;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="ow">in</span> <span class="n">req_file</span><span class="p">:</span> 
        <span class="n">req_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">www_dir</span> <span class="o">+</span> <span class="n">req_file</span>
      <span class="k">if</span> <span class="n">req_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">req_file</span> <span class="o">=</span> <span class="n">req_file</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="k">if</span> <span class="n">req_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;upload/&#39;</span><span class="p">):</span>
        <span class="n">req_file</span> <span class="o">=</span> <span class="n">req_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;upload/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Request for file: &#39;</span><span class="p">,</span> <span class="n">req_file</span><span class="p">)</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking for path traversal attempt. . .&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">req_file</span> <span class="o">==</span> <span class="s1">&#39;/upload&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_safe_path</span><span class="p">(</span><span class="n">req_file</span><span class="p">):</span> <span class="c1"># Safe to try to open file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is a safe file!&#39;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_OK</span>
      <span class="k">else</span><span class="p">:</span> <span class="c1"># return 403 Forbidden error</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_FORBIDDEN</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serve_content</span><span class="p">(</span><span class="n">req_file</span><span class="p">,</span> <span class="n">request_method</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">request_method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_upload_file</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown HTTP request method: &#39;</span><span class="p">,</span> <span class="n">request_method</span><span class="p">)</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">HTTP_STATUS_BAD_REQ</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_serve_content</span><span class="p">(</span><span class="n">req_file</span><span class="p">,</span> <span class="n">request_method</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="HttpServer._wait_for_connections"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer._wait_for_connections">[docs]</a>  <span class="k">def</span> <span class="nf">_wait_for_connections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sit in loop and wait for connections. Handle the request once</span>
<span class="sd">    a connection is received. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Listening for new connection&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">MAX_CONNECTIONS</span><span class="p">)</span>

      <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New connection from &#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">const</span><span class="o">.</span><span class="n">CHUNK_SIZE</span><span class="p">)</span>

      <span class="c1">#TODO: try-catch here w/ 500 internal error if exception??</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_handle_request</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span></div>



<div class="viewcode-block" id="HttpServer.shutdown"><a class="viewcode-back" href="../http_server.html#http_server.HttpServer.shutdown">[docs]</a>  <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Shutdown any active connections and close the socket &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span> 
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Shutting down HTTP Server. . .&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span> <span class="c1"># shut down both halves of active connection</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># Errno 57 Socket Not Connected means there were no active connections at</span>
      <span class="c1"># the time of shutting down. Ignore that error silently and close the conn.</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;Errno 57&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error while shutting down HTTP Server:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>



<div class="viewcode-block" id="stop_server"><a class="viewcode-back" href="../http_server.html#http_server.stop_server">[docs]</a><span class="k">def</span> <span class="nf">stop_server</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; If ctrl-c is caught, shut down the server gracefully and exit.&quot;&quot;&quot;</span>
  <span class="n">s</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
  <span class="c1"># Gracefully shutdown HTTP server upon ctrl-c</span>
  <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">stop_server</span><span class="p">)</span>


  <span class="n">args</span> <span class="o">=</span> <span class="n">check_args</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">HttpServer</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">start_server</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Programming_Assignment_1_CS560</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Zachary Trzil, Tyler McDaniel.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>